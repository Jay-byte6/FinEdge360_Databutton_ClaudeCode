# Google OAuth Troubleshooting Guide

## Current Issue
Getting 401 Unauthorized when trying to authenticate with Google OAuth.

## Error Details
```
GET https://ikghsrruoyisbklfniwq.supabase.co/auth/v1/user 401 (Unauthorized)
```

## Root Cause Analysis

The 401 error after Google redirects back indicates that Supabase cannot verify the OAuth session. This happens when:

1. **Google OAuth Provider Not Enabled in Supabase**
2. **Incorrect Redirect URI Configuration**
3. **Client ID/Secret Mismatch**
4. **Email Provider Not Enabled**

## Step-by-Step Fix

### Step 1: Verify Google Provider is ENABLED in Supabase

1. Go to your Supabase Dashboard: https://supabase.com/dashboard
2. Select your project: `ikghsrruoyisbklfniwq`
3. Go to **Authentication** → **Providers**
4. Find **Google** in the list
5. **CRITICAL**: Make sure the toggle switch next to Google is **ENABLED (Green)**
6. Click on Google to open the configuration panel

### Step 2: Verify Email Provider is Enabled

**IMPORTANT**: Google OAuth requires the Email provider to be enabled!

1. In the same **Authentication** → **Providers** page
2. Scroll to find **Email** provider
3. **Make sure Email provider is ENABLED**
4. If disabled, enable it and save

### Step 3: Double-Check Google OAuth Configuration

In the Google provider settings in Supabase, verify:

**Client ID (for OAuth)**:
```
572883698392-uqbf89ujj5qcc4q0fshupf2rlee2gr8c.apps.googleusercontent.com
```

**Client Secret (for OAuth)**:
```
(Your secret ending in ...rGfw)
```

**Callback URL (for OAuth)**: This should be automatically generated by Supabase
```
https://ikghsrruoyisbklfniwq.supabase.co/auth/v1/callback
```

### Step 4: Verify Google Cloud Console Configuration

1. Go to: https://console.cloud.google.com/apis/credentials
2. Select your project: **FinEdge360**
3. Click on your OAuth 2.0 Client ID: `572883698392-uqbf89ujj5qcc4q0fshupf2rlee2gr8c`

**Authorized JavaScript origins** should include:
- `http://localhost:5173`
- `https://www.finedge360.com`
- `https://ikghsrruoyisbklfniwq.supabase.co`

**Authorized redirect URIs** should include:
- `http://localhost:54321/auth/v1/callback`
- `https://ikghsrruoyisbklfniwq.supabase.co/auth/v1/callback`

### Step 5: Check Supabase Auth Settings

1. Go to **Authentication** → **Settings** in Supabase
2. Under **Site URL**, verify it's set to: `http://localhost:5173` (for local development)
3. Under **Redirect URLs**, add:
   - `http://localhost:5173/**`
   - `http://localhost:5173/dashboard`

### Step 6: Enable Confirm Email Setting

1. In **Authentication** → **Settings**
2. Find **Enable email confirmations**
3. You can DISABLE this for testing purposes (enable in production)

### Step 7: Clear Browser Data and Test Again

1. Clear all browser cache and cookies
2. Close browser completely
3. Open new incognito/private window
4. Navigate to: `http://localhost:5173/login`
5. Click "Sign In with Google"
6. Select your Google account
7. Check browser console for any new errors

## Common Mistakes

### ❌ Mistake 1: Google Provider Not Enabled
**Symptom**: 401 Unauthorized error
**Fix**: Enable Google provider toggle in Supabase

### ❌ Mistake 2: Email Provider Disabled
**Symptom**: OAuth fails silently
**Fix**: Enable Email provider in Supabase

### ❌ Mistake 3: Wrong Callback URL in Google Console
**Symptom**: Redirect error from Google
**Fix**: Must use exact Supabase callback URL

### ❌ Mistake 4: Missing localhost in Authorized Origins
**Symptom**: CORS error or blocked request
**Fix**: Add `http://localhost:5173` to JavaScript origins

## Verification Checklist

Use this checklist to verify everything is configured correctly:

### Supabase Dashboard (`ikghsrruoyisbklfniwq`)
- [ ] Google provider is **ENABLED** (toggle switch is green)
- [ ] Email provider is **ENABLED**
- [ ] Google Client ID is correctly entered
- [ ] Google Client Secret is correctly entered
- [ ] Site URL is set to `http://localhost:5173`
- [ ] Redirect URL `http://localhost:5173/**` is added

### Google Cloud Console
- [ ] OAuth 2.0 Client created for **FinEdge360**
- [ ] Client ID matches Supabase configuration
- [ ] Client Secret matches Supabase configuration
- [ ] Authorized JavaScript origins includes `http://localhost:5173`
- [ ] Authorized JavaScript origins includes `https://ikghsrruoyisbklfniwq.supabase.co`
- [ ] Authorized redirect URIs includes `https://ikghsrruoyisbklfniwq.supabase.co/auth/v1/callback`
- [ ] OAuth consent screen is configured

### Code Configuration
- [ ] `frontend/src/utils/supabase.ts` has correct project URL: `ikghsrruoyisbklfniwq`
- [ ] `frontend/src/utils/supabase.ts` has correct anon key

## Testing After Configuration

After making the changes above:

1. **Restart your development server**:
   ```bash
   # Kill existing process
   # Then restart
   cd frontend
   npm run dev
   ```

2. **Test OAuth Flow**:
   - Open http://localhost:5173/login
   - Click "Sign In with Google"
   - You should be redirected to Google
   - After selecting account, you should be redirected back
   - Should land on dashboard with success message

3. **Check Console Logs**:
   - Should see: "Auth state change: SIGNED_IN Session exists"
   - Should see: "User signed in via OAuth, refreshing session"
   - Should see: "Redirecting to dashboard"

## If Still Not Working

If you still get 401 error after following all steps:

1. **Screenshot the following and share**:
   - Supabase → Authentication → Providers → Google (showing enabled state)
   - Supabase → Authentication → Settings → Site URL
   - Google Cloud Console → Credentials → Your OAuth Client (showing authorized URIs)
   - Browser console showing the full error stack

2. **Try creating a NEW OAuth Client in Google Cloud**:
   - Sometimes the old client gets corrupted
   - Create fresh client with same settings
   - Update Supabase with new credentials

3. **Verify Supabase Project Status**:
   - Make sure project is not paused
   - Check if there are any service disruptions

## Additional Debug Information

To get more detailed error information, temporarily add this code to `frontend/src/components/AppProvider.tsx`:

```typescript
// In the onAuthStateChange listener
const { data } = supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('=== AUTH STATE CHANGE DEBUG ===');
  console.log('Event:', event);
  console.log('Session:', session);
  console.log('Session exists:', !!session);
  console.log('User exists:', !!session?.user);
  if (session) {
    console.log('User ID:', session.user?.id);
    console.log('User Email:', session.user?.email);
  }
  console.log('=============================');

  // ... rest of the code
});
```

This will help identify exactly what's happening during the OAuth callback.

---

**Most Likely Issue**: The Google provider toggle is not enabled in Supabase. Please verify this first!
